<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arazi Çalışma Haritası</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #f0f2f5;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.97);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 280px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 6px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .panel-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .panel-content.open {
            max-height: 500px;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-align: left;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.active {
            background: #e74c3c;
        }
        
        button i {
            margin-right: 8px;
            width: 18px;
            text-align: center;
        }
        
        button#location-btn {
            background: #2ecc71;
        }
        
        button#location-btn.active {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 280px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .info-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .info-value {
            color: #3498db;
            font-weight: 500;
            font-size: 14px;
        }
        
        .elevation-value {
            color: #e74c3c;
        }
        
        .accuracy-value {
            color: #f39c12;
        }
        
        .heading-value {
            color: #9b59b6;
        }
        
        .toggle-icon {
            transition: transform 0.3s;
            color: #7f8c8d;
        }
        
        .toggle-icon.open {
            transform: rotate(180deg);
        }
        
        .offline-warning {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #e67e22;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .compass {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .compass-arrow {
            width: 25px;
            height: 25px;
            background: #e74c3c;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            transform-origin: center;
            transition: transform 0.1s ease;
        }
        
        .compass-label {
            position: absolute;
            top: 5px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .distance-tools {
            position: absolute;
            top: 100px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .distance-btn {
            padding: 8px 12px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .marker-counter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .screenshot-btn {
            position: absolute;
            top: 170px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="offline-warning" id="offline-warning">
        <i class="fas fa-exclamation-triangle"></i> İnternet bağlantısı kesildi. Konum takibi devam ediyor.
    </div>
    
    <div class="compass">
        <div class="compass-label">K</div>
        <div class="compass-arrow" id="compass-arrow"></div>
    </div>
    
    <div class="distance-tools">
        <button class="distance-btn" id="measure-distance"><i class="fas fa-ruler"></i> Mesafe Ölç</button>
        <button class="distance-btn" id="clear-measurements"><i class="fas fa-trash"></i> Temizle</button>
    </div>
    
    <div class="screenshot-btn">
        <button class="distance-btn" id="screenshot-btn"><i class="fas fa-camera"></i> Görüntü Al</button>
    </div>
    
    <div class="marker-counter">
        <i class="fas fa-map-marker-alt"></i> İşaretleyiciler: <span id="marker-count">0</span>
    </div>
    
    <div class="info-panel">
        <h3 style="margin-top: 0; margin-bottom: 10px; color: #2c3e50; font-size: 16px;">Konum Bilgileri</h3>
        <div class="info-item">
            <span class="info-label">Enlem:</span>
            <span class="info-value" id="info-lat">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Boylam:</span>
            <span class="info-value" id="info-lng">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Rakım:</span>
            <span class="info-value elevation-value" id="info-elevation">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Hassasiyet:</span>
            <span class="info-value accuracy-value" id="info-accuracy">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Yön:</span>
            <span class="info-value heading-value" id="info-heading">-</span>
        </div>
    </div>
    
    <div class="control-panel">
        <div class="control-group">
            <div class="panel-header" id="basemap-header">
                <h3><i class="fas fa-map"></i> Altlık Haritalar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="basemap-content">
                <button id="osm-btn"><i class="fas fa-road"></i> OpenStreetMap</button>
                <button id="satellite-btn"><i class="fas fa-satellite"></i> Uydu Görünümü</button>
                <button id="terrain-btn"><i class="fas fa-mountain"></i> Topoğrafya</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="panel-header" id="layers-header">
                <h3><i class="fas fa-layer-group"></i> Katmanlar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="layers-content">
                <button id="havza-btn"><i class="fas fa-water"></i> Havza Sınırı</button>
                <button id="mahalle-btn"><i class="fas fa-map-marked-alt"></i> Mahalle Sınırları</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="panel-header" id="tools-header">
                <h3><i class="fas fa-tools"></i> Araçlar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="tools-content">
                <button id="location-btn"><i class="fas fa-location-arrow"></i> Konum Takibi</button>
                <button id="add-marker-btn"><i class="fas fa-map-marker-alt"></i> İşaretleyici Ekle</button>
            </div>
        </div>
    </div>

    <script>
        // Harita oluşturma - Erzurum civarında başlangıç
        const map = L.map('map').setView([39.9, 41.3], 12);
        
        // Altlık haritalar (Basemaps)
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a>',
            maxZoom: 17
        });

        // Katman grupları
        const havzaLayer = L.layerGroup();
        const mahalleLayer = L.layerGroup();
        const markerLayer = L.layerGroup().addTo(map);
        
        // Konum takibi için değişkenler
        let locationMarker = null;
        let locationCircle = null;
        let isTracking = false;
        
        // İşaretleyici sayacı
        let markerCount = 0;
        const markers = [];
        
        // Pusula için değişken
        let currentHeading = 0;

        // Pusula yönünü güncelle
        function updateCompass(heading) {
            const compassArrow = document.getElementById('compass-arrow');
            if (compassArrow) {
                compassArrow.style.transform = `rotate(${360 - heading}deg)`;
                currentHeading = heading;
                
                // Yön bilgisini güncelle
                document.getElementById('info-heading').textContent = `${Math.round(heading)}°`;
            }
        }
        
        // Konum bulunduğunda
        function onLocationFound(e) {
            const radius = e.accuracy / 2;
            const statusElement = document.getElementById('info-accuracy');
            
            if (locationMarker) {
                map.removeLayer(locationMarker);
            }
            if (locationCircle) {
                map.removeLayer(locationCircle);
            }

            locationMarker = L.marker(e.latlng).addTo(map)
                .bindPopup(`<b>Bulunduğunuz konum</b><br>Enlem: ${e.latlng.lat.toFixed(6)}<br>Boylam: ${e.latlng.lng.toFixed(6)}<br>Doğruluk: ${Math.round(e.accuracy)} metre`).openPopup();

            locationCircle = L.circle(e.latlng, radius).addTo(map);
            
            // Konum bilgilerini güncelle
            document.getElementById('info-lat').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('info-lng').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('info-accuracy').textContent = `${Math.round(e.accuracy)} metre`;
            
            // Pusulayı güncelle (yön bilgisi varsa)
            if (e.heading) {
                updateCompass(e.heading);
            }
            
            // Rakım bilgisini al
            getElevation(e.latlng.lat, e.latlng.lng);
            
            // Harita görünümünü konuma odakla (ilk seferinde)
            if (!isTracking) {
                map.setView(e.latlng, 16);
                isTracking = true;
            }
        }

        // Konum hatası
        function onLocationError(e) {
            alert("Konum bilgisi alınamadı. Lütfen tarayıcınızın konum iznini etkinleştirin.");
        }

        // Konum takibini başlat/durdur
        function toggleLocationTracking() {
            if (isTracking) {
                // Konum takibini durdur
                map.stopLocate();
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                    locationMarker = null;
                }
                if (locationCircle) {
                    map.removeLayer(locationCircle);
                    locationCircle = null;
                }
                isTracking = false;
                document.getElementById('location-btn').classList.remove('active');
            } else {
                // Konum takibini başlat
                map.locate({
                    watch: true,
                    setView: false,
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    timeout: 10000
                });
                isTracking = true;
                document.getElementById('location-btn').classList.add('active');
            }
        }
        
        // Rakım/yükseklik bilgisi alma fonksiyonu
        async function getElevation(lat, lng) {
            const elevationInfo = document.getElementById('info-elevation');
            
            try {
                elevationInfo.textContent = 'Hesaplanıyor...';
                
                // Open-Elevation API'sini kullan
                const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                
                if (!response.ok) {
                    throw new Error('Rakım bilgisi alınamadı');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const elevation = data.results[0].elevation;
                    elevationInfo.textContent = `${elevation.toFixed(1)} metre`;
                    return elevation;
                } else {
                    throw new Error('Rakım verisi bulunamadı');
                }
            } catch (error) {
                console.error('Rakım bilgisi alınırken hata oluştu:', error);
                elevationInfo.textContent = 'Hata';
                return null;
            }
        }
        
        // İşaretleyici ekle
        function addMarker() {
            const center = map.getCenter();
            const marker = L.marker(center, {
                title: `İşaretleyici ${markerCount + 1}`
            }).addTo(markerLayer);
            
            marker.bindPopup(`
                <div style="text-align:center;">
                    <b>İşaretleyici ${markerCount + 1}</b><br>
                    Enlem: ${center.lat.toFixed(6)}<br>
                    Boylam: ${center.lng.toFixed(6)}<br>
                    <button onclick="removeMarker(${markerCount})" style="margin-top:5px; padding:3px 8px; background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer;">Kaldır</button>
                </div>
            `).openPopup();
            
            markers.push(marker);
            markerCount++;
            document.getElementById('marker-count').textContent = markerCount;
        }
        
        // İşaretleyici kaldır
        function removeMarker(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers.splice(index, 1);
                markerCount--;
                document.getElementById('marker-count').textContent = markerCount;
            }
        }
        
        // Mesafe ölçme aracını başlat
        function initMeasureTool() {
            alert("Mesafe ölçme aracı aktif. Haritaya tıklayarak noktaları işaretleyin.");
        }
        
        // Ekran görüntüsü al
        function takeScreenshot() {
            alert("Ekran görüntüsü alma özelliği için tarayıcınızın yazdırma özelliğini kullanabilirsiniz. (Ctrl+P)");
        }
        
        // Açılır-kapanır menü işlevselliği
        document.getElementById('basemap-header').addEventListener('click', function() {
            const content = document.getElementById('basemap-content');
            const icon = this.querySelector('.toggle-icon');
            
            content.classList.toggle('open');
            icon.classList.toggle('open');
        });

        document.getElementById('layers-header').addEventListener('click', function() {
            const content = document.getElementById('layers-content');
            const icon = this.querySelector('.toggle-icon');
            
            content.classList.toggle('open');
            icon.classList.toggle('open');
        });

        document.getElementById('tools-header').addEventListener('click', function() {
            const content = document.getElementById('tools-content');
            const icon = this.querySelector('.toggle-icon');
            
            content.classList.toggle('open');
            icon.classList.toggle('open');
        });

        // Buton olayları
        document.getElementById('osm-btn').addEventListener('click', function() {
            map.removeLayer(satelliteLayer);
            map.removeLayer(terrainLayer);
            osmLayer.addTo(map);
            this.classList.add('active');
            document.getElementById('satellite-btn').classList.remove('active');
            document.getElementById('terrain-btn').classList.remove('active');
        });

        document.getElementById('satellite-btn').addEventListener('click', function() {
            map.removeLayer(osmLayer);
            map.removeLayer(terrainLayer);
            satelliteLayer.addTo(map);
            this.classList.add('active');
            document.getElementById('osm-btn').classList.remove('active');
            document.getElementById('terrain-btn').classList.remove('active');
        });

        document.getElementById('terrain-btn').addEventListener('click', function() {
            map.removeLayer(osmLayer);
            map.removeLayer(satelliteLayer);
            terrainLayer.addTo(map);
            this.classList.add('active');
            document.getElementById('osm-btn').classList.remove('active');
            document.getElementById('satellite-btn').classList.remove('active');
        });

        document.getElementById('havza-btn').addEventListener('click', function() {
            if (map.hasLayer(havzaLayer)) {
                map.removeLayer(havzaLayer);
                this.classList.remove('active');
            } else {
                havzaLayer.addTo(map);
                this.classList.add('active');
            }
        });

        document.getElementById('mahalle-btn').addEventListener('click', function() {
            if (map.hasLayer(mahalleLayer)) {
                map.removeLayer(mahalleLayer);
                this.classList.remove('active');
            } else {
                mahalleLayer.addTo(map);
                this.classList.add('active');
            }
        });

        document.getElementById('location-btn').addEventListener('click', toggleLocationTracking);
        document.getElementById('add-marker-btn').addEventListener('click', addMarker);
        document.getElementById('measure-distance').addEventListener('click', initMeasureTool);
        document.getElementById('screenshot-btn').addEventListener('click', takeScreenshot);
        document.getElementById('clear-measurements').addEventListener('click', function() {
            markerLayer.clearLayers();
            markerCount = 0;
            markers.length = 0;
            document.getElementById('marker-count').textContent = '0';
        });

        // Konum bulma olaylarını dinle
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // Varsayılan olarak OSM butonunu aktif göster
        document.getElementById('osm-btn').classList.add('active');
        
        // Sayfa yüklendiğinde katman menülerini açık bırak
        document.getElementById('basemap-content').classList.add('open');
        document.getElementById('layers-content').classList.add('open');
        document.getElementById('tools-content').classList.add('open');
        document.querySelectorAll('.toggle-icon').forEach(icon => icon.classList.add('open'));
        
        // Pusulayı başlangıçta Kuzey'i gösterecek şekilde ayarla
        updateCompass(0);
    </script>
</body>
</html>
