<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arazi Çalışma Haritası</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: #f0f2f5;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.97);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 6px;
            border-bottom: 1px solid #eaeaea;
            transition: background-color 0.2s;
        }
        .panel-header:hover {
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 5px;
        }
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }
        .panel-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .panel-content.open {
            max-height: 500px;
        }
        .control-group {
            margin-bottom: 12px;
        }
        button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        button.active {
            background: #e74c3c;
        }
        button i {
            margin-right: 8px;
            width: 18px;
            text-align: center;
        }
        button#location-btn {
            background: #2ecc71;
        }
        button#location-btn.active {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 300px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .info-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .info-label {
            font-weight: 600;
            color: #2c3e50;
        }
        .info-value {
            color: #3498db;
            font-weight: 500;
        }
        .elevation-value {
            color: #e74c3c;
        }
        .accuracy-value {
            color: #f39c12;
        }
        .heading-value {
            color: #9b59b6;
        }
        .toggle-icon {
            transition: transform 0.3s;
            color: #7f8c8d;
        }
        .toggle-icon.open {
            transform: rotate(180deg);
        }
        .offline-warning {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #e67e22;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: fadeInOut 2s infinite;
        }
        @keyframes fadeInOut {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        .compass {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .compass-arrow {
            width: 30px;
            height: 30px;
            background: #e74c3c;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            transform-origin: center;
            transition: transform 0.1s ease;
        }
        .compass-label {
            position: absolute;
            top: 5px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #e74c3c;
        }
        .distance-tools {
            position: absolute;
            top: 110px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .distance-btn {
            padding: 8px 12px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        .marker-counter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .slope-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        .slope-low {
            background: #2ecc71;
            color: white;
        }
        .slope-medium {
            background: #f39c12;
            color: white;
        }
        .slope-high {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="offline-warning" id="offline-warning">
        <i class="fas fa-exclamation-triangle"></i> İnternet bağlantısı kesildi. Konum takibi devam ediyor.
    </div>
    
    <div class="compass">
        <div class="compass-label">K</div>
        <div class="compass-arrow" id="compass-arrow"></div>
    </div>
    
    <div class="distance-tools">
        <button class="distance-btn" id="measure-distance"><i class="fas fa-ruler"></i> Mesafe Ölç</button>
        <button class="distance-btn" id="clear-measurements"><i class="fas fa-trash"></i> Temizle</button>
    </div>
    
    <div class="marker-counter">
        <i class="fas fa-map-marker-alt"></i> İşaretleyiciler: <span id="marker-count">0</span>
    </div>
    
    <div class="info-panel">
        <h3 style="margin-top: 0; color: #2c3e50;">Konum Bilgileri</h3>
        <div class="info-item">
            <span class="info-label">Enlem:</span>
            <span class="info-value" id="info-lat">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Boylam:</span>
            <span class="info-value" id="info-lng">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Rakım:</span>
            <span class="info-value elevation-value" id="info-elevation">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Hassasiyet:</span>
            <span class="info-value accuracy-value" id="info-accuracy">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Yön:</span>
            <span class="info-value heading-value" id="info-heading">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Eğim:</span>
            <span class="info-value" id="info-slope">-</span>
        </div>
    </div>
    
    <div class="control-panel">
        <div class="control-group">
            <div class="panel-header" id="basemap-header">
                <h3><i class="fas fa-map"></i> Altlık Haritalar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="basemap-content">
                <button id="osm-btn"><i class="fas fa-road"></i> OpenStreetMap</button>
                <button id="satellite-btn"><i class="fas fa-satellite"></i> Uydu Görünümü</button>
                <button id="terrain-btn"><i class="fas fa-mountain"></i> Topoğrafya</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="panel-header" id="layers-header">
                <h3><i class="fas fa-layer-group"></i> Katmanlar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="layers-content">
                <button id="havza-btn"><i class="fas fa-water"></i> Havza Sınırı</button>
                <button id="mahalle-btn"><i class="fas fa-map-marked-alt"></i> Mahalle Sınırları</button>
                <button id="contour-btn"><i class="fas fa-wave-square"></i> Eşyükselti Eğrileri</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="panel-header" id="tools-header">
                <h3><i class="fas fa-tools"></i> Araçlar</h3>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="panel-content" id="tools-content">
                <button id="location-btn"><i class="fas fa-location-arrow"></i> Hassas Konum Takibi</button>
                <button id="add-marker-btn"><i class="fas fa-map-marker-alt"></i> İşaretleyici Ekle</button>
                <button id="track-recording-btn"><i class="fas fa-record-vinyl"></i> Rota Kaydı</button>
                <button id="screenshot-btn"><i class="fas fa-camera"></i> Ekran Görüntüsü Al</button>
            </div>
        </div>
    </div>

    <script>
        // Harita oluşturma - Erzurum civarında başlangıç
        const map = L.map('map').setView([39.9, 41.3], 12);
        
        // Pusula için değişken
        let currentHeading = 0;
        
        // Ölçüm için değişkenler
        let measureControl = null;
        let isMeasuring = false;
        
        // İşaretleyici sayacı
        let markerCount = 0;
        const markers = [];
        let markerLayer = L.layerGroup().addTo(map);
        
        // Rota kaydı için değişkenler
        let isTrackingPath = false;
        let pathPoints = [];
        let pathPolyline = null;
        
        // Eğim hesaplama için değişkenler
        let lastPosition = null;
        let lastElevation = null;

        // Altlık haritalar (Basemaps)
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: © <a href="https://opentopomap.org">OpenTopoMap</a>',
            maxZoom: 17
        });

        // Eşyükselti eğrileri katmanı
        const contourLayer = L.layerGroup();
        
        // Çevrimdışı durumda kullanılacak basit grid katmanı
        const gridLayer = L.layerGroup();

        // Katman grupları
        const havzaLayer = L.layerGroup();
        const mahalleLayer = L.layerGroup();
        
        // GeoJSON stillendirme
        const havzaStyle = {
            color: "#FF0000",
            weight: 3,
            opacity: 0.8,
            fillOpacity: 0.1,
            fillColor: "#FF0000"
        };
        
        const mahalleStyle = {
            color: "#0000FF",
            weight: 2,
            opacity: 0.7,
            fillOpacity: 0.1,
            fillColor: "#0000FF"
        };

        // Çevrimdışı izleme
        let isOnline = navigator.onLine;
        const offlineWarning = document.getElementById('offline-warning');
        
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            if (!isOnline) {
                offlineWarning.style.display = 'block';
                addOfflineGrid();
            } else {
                offlineWarning.style.display = 'none';
                map.removeLayer(gridLayer);
                if (map.hasLayer(osmLayer) || map.hasLayer(satelliteLayer) || map.hasLayer(terrainLayer)) {
                    // Zaten bir katman yüklü
                } else {
                    osmLayer.addTo(map);
                }
            }
        }
        
        function addOfflineGrid() {
            map.removeLayer(osmLayer);
            map.removeLayer(satelliteLayer);
            map.removeLayer(terrainLayer);
            
            gridLayer.clearLayers();
            
            const bounds = map.getBounds();
            const zoom = map.getZoom();
            const latLngStep = 0.01;
            
            for (let lat = bounds.getSouth(); lat < bounds.getNorth(); lat += latLngStep) {
                for (let lng = bounds.getWest(); lng < bounds.getEast(); lng += latLngStep) {
                    if (zoom > 12) {
                        L.rectangle([[lat, lng], [lat + latLngStep, lng + latLngStep]], {
                            color: '#ccc',
                            weight: 0.5,
                            fill: false
                        }).addTo(gridLayer);
                    }
                }
            }
            
            gridLayer.addTo(map);
        }

        // Pusula yönünü güncelle
        function updateCompass(heading) {
            const compassArrow = document.getElementById('compass-arrow');
            compassArrow.style.transform = `rotate(${360 - heading}deg)`;
            currentHeading = heading;
            
            // Yön bilgisini güncelle
            document.getElementById('info-heading').textContent = `${Math.round(heading)}° (${getDirectionFromDegree(heading)})`;
        }
        
        // Dereceyi yön ismine çevir
        function getDirectionFromDegree(degree) {
            const directions = ['K', 'KKD', 'KD', 'DKD', 'D', 'DGD', 'GD', 'GGD', 'G', 'GGB', 'GB', 'BGB', 'B', 'BKB', 'KB', 'KKB'];
            return directions[Math.round(degree / 22.5) % 16];
        }
        
        // Eğim hesapla ve göster
        function calculateSlope(newPosition, newElevation) {
            if (!lastPosition || !lastElevation) return null;
            
            // Mesafe hesapla (Haversine formülü)
            const R = 6371000; // Dünya yarıçapı metre cinsinden
            const φ1 = lastPosition.lat * Math.PI/180;
            const φ2 = newPosition.lat * Math.PI/180;
            const Δφ = (newPosition.lat - lastPosition.lat) * Math.PI/180;
            const Δλ = (newPosition.lng - lastPosition.lng) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            // Yükseklik farkı
            const elevationDiff = newElevation - lastElevation;
            
            // Eğim (derece cinsinden)
            const slopeRad = Math.atan(elevationDiff / distance);
            const slopeDeg = slopeRad * 180 / Math.PI;
            
            return {
                slope: slopeDeg,
                distance: distance,
                elevationDiff: elevationDiff
            };
        }
        
        // Eğim bilgisini formatla
        function formatSlopeInfo(slopeData) {
            if (!slopeData) return "-";
            
            const slope = slopeData.slope;
            let slopeClass = "slope-low";
            if (slope > 10) slopeClass = "slope-medium";
            if (slope > 20) slopeClass = "slope-high";
            
            return `${slope.toFixed(1)}° <span class="slope-indicator ${slopeClass}">${slope > 10 ? (slope > 20 ? "Dik" : "Orta") : "Hafif"}</span>`;
        }

        // Rakım/yükseklik bilgisi alma fonksiyonu
        async function getElevation(lat, lng) {
            const elevationInfo = document.getElementById('info-elevation');
            
            if (!isOnline) {
                elevationInfo.textContent = 'İnternet gerekli';
                return null;
            }
            
            try {
                elevationInfo.textContent = 'Hesaplanıyor...';
                
                // Open-Elevation API'sini kullan
                const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                
                if (!response.ok) {
                    throw new Error('Rakım bilgisi alınamadı');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const elevation = data.results[0].elevation;
                    elevationInfo.textContent = `${elevation.toFixed(1)} m`;
                    
                    // Eğim hesapla
                    if (lastPosition && lastElevation) {
                        const slopeData = calculateSlope(L.latLng(lat, lng), elevation);
                        if (slopeData) {
                            document.getElementById('info-slope').innerHTML = formatSlopeInfo(slopeData);
                        }
                    }
                    
                    // Son konumu ve yüksekliği kaydet
                    lastPosition = L.latLng(lat, lng);
                    lastElevation = elevation;
                    
                    return elevation;
                } else {
                    throw new Error('Rakım verisi bulunamadı');
                }
            } catch (error) {
                console.error('Rakım bilgisi alınırken hata oluştu:', error);
                elevationInfo.textContent = 'Hata';
                return null;
            }
        }
        
        // Mesafe ölçme aracını başlat
        function initMeasureTool() {
            if (isMeasuring) {
                if (measureControl) {
                    map.removeControl(measureControl);
                }
                isMeasuring = false;
                document.getElementById('measure-distance').innerHTML = '<i class="fas fa-ruler"></i> Mesafe Ölç';
                return;
            }
            
            // Leaflet MeasurePath eklentisi benzeri işlev
            let startPoint = null;
            let measureLine = null;
            let measurePoints = [];
            let totalDistance = 0;
            
            function onMapClick(e) {
                if (!isMeasuring) return;
                
                if (!startPoint) {
                    startPoint = e.latlng;
                    measurePoints = [startPoint];
                    
                    // Ölçüm çizgisi oluştur
                    measureLine = L.polyline(measurePoints, {
                        color: '#3498db',
                        weight: 3,
                        dashArray: '5, 10'
                    }).addTo(map);
                    
                    // Başlangıç noktası işaretleyici
                    L.marker(startPoint, {
                        icon: L.divIcon({
                            className: 'measure-marker',
                            html: '<div style="background-color:#3498db; width:12px; height:12px; border-radius:50%;"></div>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map);
                } else {
                    // Mesafeyi hesapla ve toplama ekle
                    const lastPoint = measurePoints[measurePoints.length - 1];
                    const distance = map.distance(lastPoint, e.latlng);
                    totalDistance += distance;
                    
                    // Noktayı ekle
                    measurePoints.push(e.latlng);
                    measureLine.setLatLngs(measurePoints);
                    
                    // Mesafe bilgisini göster
                    L.circleMarker(e.latlng, {
                        radius: 5,
                        color: '#3498db',
                        fillColor: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map).bindTooltip(`${totalDistance.toFixed(1)} m`, {
                        permanent: false,
                        direction: 'top'
                    });
                }
            }
            
            map.on('click', onMapClick);
            isMeasuring = true;
            document.getElementById('measure-distance').innerHTML = '<i class="fas fa-stop"></i> Ölçümü Durdur';
            
            // Ölçümü durdurma işlevi
            window.stopMeasure = function() {
                map.off('click', onMapClick);
                if (measureLine) {
                    map.removeLayer(measureLine);
                }
                startPoint = null;
                isMeasuring = false;
                document.getElementById('measure-distance').innerHTML = '<i class="fas fa-ruler"></i> Mesafe Ölç';
            };
        }
        
        // İşaretleyici ekle
        function addMarker(latlng) {
            const marker = L.marker(latlng, {
                title: `İşaretleyici ${markerCount + 1}`
            }).addTo(markerLayer);
            
            marker.bindPopup(`
                <div style="text-align:center;">
                    <b>İşaretleyici ${markerCount + 1}</b><br>
                    Enlem: ${latlng.lat.toFixed(6)}<br>
                    Boylam: ${latlng.lng.toFixed(6)}<br>
                    <button onclick="removeMarker(${markerCount})" style="margin-top:5px; padding:3px 8px; background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer;">Kaldır</button>
                </div>
            `);
            
            markers.push(marker);
            markerCount++;
            document.getElementById('marker-count').textContent = markerCount;
            
            // İşaretleyiciye tıklama olayı ekle
            marker.on('click', function() {
                map.setView(latlng, 16);
            });
        }
        
        // İşaretleyici kaldır
        function removeMarker(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers.splice(index, 1);
                markerCount--;
                document.getElementById('marker-count').textContent = markerCount;
                
                // Tüm işaretleyicileri yeniden numaralandır
                markers.forEach((marker, i) => {
                    const latlng = marker.getLatLng();
                    marker.setPopupContent(`
                        <div style="text-align:center;">
                            <b>İşaretleyici ${i + 1}</b><br>
                            Enlem: ${latlng.lat.toFixed(6)}<br>
                            Boylam: ${latlng.lng.toFixed(6)}<br>
                            <button onclick="removeMarker(${i})" style="margin-top:5px; padding:3px 8px; background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer;">Kaldır</button>
                        </div>
                    `);
                });
            }
        }
        
        // Rota kaydını başlat/durdur
        function toggleTrackRecording() {
            if (isTrackingPath) {
                // Kaydı durdur
                isTrackingPath = false;
                document.getElementById('track-recording-btn').innerHTML = '<i class="fas fa-record-vinyl"></i> Rota Kaydı';
                document.getElementById('track-recording-btn').classList.remove('active');
                
                // Kaydedilen rotayı temizle butonunu göster
                if (pathPoints.length > 1) {
                    L.popup()
                        .setLatLng(pathPoints[pathPoints.length - 1])
                        .setContent(`<div style="text-align:center;"><b>Rota kaydı tamamlandı</b><br>${pathPoints.length} nokta kaydedildi<br><button onclick="clearRecordedPath()" style="margin-top:5px; padding:5px 10px; background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer;">Rotayı Temizle</button></div>`)
                        .openOn(map);
                }
            } else {
                // Kaydı başlat
                isTrackingPath = true;
                pathPoints = [];
                document.getElementById('track-recording-btn').innerHTML = '<i class="fas fa-stop"></i> Kaydı Durdur';
                document.getElementById('track-recording-btn').classList.add('active');
                
                if (pathPolyline) {
                    map.removeLayer(pathPolyline);
                }
                
                pathPolyline = L.polyline([], {
                    color: '#e74c3c',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
                
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent('<div style="text-align:center;"><b>Rota kaydı başlatıldı</b><br>Yürüdüğünüz yolu takip ediyoruz</div>')
                    .openOn(map);
            }
        }
        
        // Kaydedilmiş rotayı temizle
        function clearRecordedPath() {
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
                pathPolyline = null;
            }
            pathPoints = [];
            isTrackingPath = false;
            document.getElementById('track-recording-btn').innerHTML = '<i class="fas fa-record-vinyl"></i> Rota Kaydı';
            document.getElementById('track-recording-btn').classList.remove('active');
        }
        
        // Ekran görüntüsü al
        function takeScreenshot() {
            // Harita görünümünü bir div olarak kopyala
            const mapContainer = map.getContainer();
            html2canvas(mapContainer).then(canvas => {
                // Görüntüyü indir
                const link = document.createElement('a');
                link.download = 'arazi-calismasi-' + new Date().toISOString().replace(/:/g, '-') + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        // GeoJSON dosyalarını yükleme
        function loadGeoJSONData() {
            fetch('Data/havza_wgs84.geojson')
                .then(response => {
                    if (!response.ok) throw new Error('Havza GeoJSON dosyası bulunamadı');
                    return response.json();
                })
                .then(data => {
                    L.geoJSON(data, {
                        style: havzaStyle,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && feature.properties.name) {
                                layer.bindPopup(`Havza: ${feature.properties.name}`);
                            }
                        }
                    }).addTo(havzaLayer);
                    
                    try {
                        localStorage.setItem('havzaData', JSON.stringify(data));
                    } catch (e) {
                        console.warn('Havza verisi localStorage\'a kaydedilemedi:', e);
                    }
                })
                .catch(error => {
                    console.error('Havza GeoJSON yüklenirken hata oluştu:', error);
                    try {
                        const savedData = localStorage.getItem('havzaData');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            L.geoJSON(data, {
                                style: havzaStyle,
                                onEachFeature: function(feature, layer) {
                                    if (feature.properties && feature.properties.name) {
                                        layer.bindPopup(`Havza: ${feature.properties.name}`);
                                    }
                                }
                            }).addTo(havzaLayer);
                        }
                    } catch (e) {
                        console.error('Çevrimdışı havza verisi yüklenemedi:', e);
                    }
                });

            fetch('Data/mahalle_wgs84.geojson')
                .then(response => {
                    if (!response.ok) throw new Error('Mahalle GeoJSON dosyası bulunamadı');
                    return response.json();
                })
                .then(data => {
                    L.geoJSON(data, {
                        style: mahalleStyle,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && feature.properties.name) {
                                layer.bindPopup(`Mahalle: ${feature.properties.name}`);
                            }
                        }
                    }).addTo(mahalleLayer);
                    
                    try {
                        localStorage.setItem('mahalleData', JSON.stringify(data));
                    } catch (e) {
                        console.warn('Mahalle verisi localStorage\'a kaydedilemedi:', e);
                    }
                })
                .catch(error => {
                    console.error('Mahalle GeoJSON yüklenirken hata oluştu:', error);
                    try {
                        const savedData = localStorage.getItem('mahalleData');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            L.geoJSON(data, {
                                style: mahalleStyle,
                                onEachFeature: function(feature, layer) {
                                    if (feature.properties && feature.properties.name) {
                                        layer.bindPopup(`Mahalle: ${feature.properties.name}`);
                                    }
                                }
                            }).addTo(mahalleLayer);
                        }
                    } catch (e) {
                        console.error('Çevrimdışı mahalle verisi yüklenemedi:', e);
                    }
                });
        }

        // Konum takibi
        let locationMarker = null;
        let locationCircle = null;
        let isTracking = false;
        let watchId = null;
        let positionHistory = [];
        const MAX_POSITION_HISTORY = 100;

        async function onLocationFound(e) {
            const radius = e.accuracy
